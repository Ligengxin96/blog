<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="前端使用Ant design Upload组件上传文件到阿里云OSS的坑" /><meta name="author" content="Gengxin Li" /><meta property="og:locale" content="en_US" /><meta name="description" content="  业务需求需要上传文件,那就想办法整呗,一顿操作过后选择了阿里云OSS." /><meta property="og:description" content="  业务需求需要上传文件,那就想办法整呗,一顿操作过后选择了阿里云OSS." /><link rel="canonical" href="/posts/work-problem-Ali-OSS/" /><meta property="og:url" content="/posts/work-problem-Ali-OSS/" /><meta property="og:site_name" content="Ligengxin’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-07T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="前端使用Ant design Upload组件上传文件到阿里云OSS的坑" /><meta name="twitter:site" content="@Ligengxin1" /><meta name="twitter:creator" content="@Gengxin Li" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"  业务需求需要上传文件,那就想办法整呗,一顿操作过后选择了阿里云OSS.","url":"/posts/work-problem-Ali-OSS/","headline":"前端使用Ant design Upload组件上传文件到阿里云OSS的坑","dateModified":"2021-01-07T00:00:00+08:00","datePublished":"2021-01-07T00:00:00+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/work-problem-Ali-OSS/"},"author":{"@type":"Person","name":"Gengxin Li"},"@context":"https://schema.org"}</script><title>前端使用Ant design Upload组件上传文件到阿里云OSS的坑 | Ligengxin's Blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-ZPEXTB9VTS"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ZPEXTB9VTS'); }); </script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPEXTB9VTS"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ZPEXTB9VTS'); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars3.githubusercontent.com/u/46650314?s=460&u=fe0b26243b450e677f5b3bc9c97c6c5c2d9a81a4&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ligengxin's Blog</a></div><div class="site-subtitle font-italic">Be a programmer Don't be a CRUDer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Ligengxin96" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/Ligengxin1" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ligengxin96','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); toggle.setDark(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>前端使用Ant design Upload组件上传文件到阿里云OSS的坑</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>前端使用Ant design Upload组件上传文件到阿里云OSS的坑</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Jan 7, 2021, 12:00 AM +0800" > Jan 7 <i class="unloaded">2021-01-07T00:00:00+08:00</i> </span> by <span class="author"> Gengxin Li </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="946 words">5 min</span></div></div><div class="post-content"><p>  业务需求需要上传文件,那就想办法整呗,一顿操作过后选择了阿里云OSS.</p><h2 id="1问题出现">1.问题出现</h2><p>  跟着阿里云文档一步步操作过来的,但是还是出现了一个403错误</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nt">&lt;Error&gt;</span>
  <span class="nt">&lt;Code&gt;</span>SignatureDoesNotMatch<span class="nt">&lt;/Code&gt;</span>
  <span class="nt">&lt;Message&gt;</span>The request signature we calculated does not match the signature you provided. Check your key and signing method.<span class="nt">&lt;/Message&gt;</span>
<span class="nt">&lt;/Error&gt;</span>
</pre></table></code></div></div><p>  当时就想,这个问题很明显嘛,签名生成错误呗,应该是哪里写错了吧,回去对比下文档和代码吧.en?怎么回事,明明是完全按照文档的来啊,<a href="https://help.aliyun.com/document_detail/31988.html">文档</a>的附录写着签名方法是<code class="language-plaintext highlighter-rouge">Signature = base64(hmac-sha1(base64(policy), AccessKeySecret))</code>这样生成的啊.我的确也是这样做的啊<code class="language-plaintext highlighter-rouge">const Signature = CryptoJS.HmacSHA1(policyBase64, secret)</code> 为啥我还是报错.Google找了半个小时资料愣是没找到答案.<del>想骂人了</del></p><p>  后来我发现在附录的下面有一个更多参考<a href="https://help.aliyun.com/document_detail/31925.html?spm=a2c4g.11186623.2.15.6d017a33df1Er2">JavaScript客户端签名直传</a> 在这个页面里面我找到了一份参考代码—<a href="http://gosspublic.alicdn.com/doc/oss-h5-upload-js-direct.zip&quot;">浏览器客户端代码</a>打开一看,好家伙这里面的签名的生成方式竟然是这样的</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// 完整代码可以点击浏览器客户端代码下载</span>
<span class="kd">var</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="nx">Crypto</span><span class="p">.</span><span class="nx">HMAC</span><span class="p">(</span><span class="nx">Crypto</span><span class="p">.</span><span class="nx">SHA1</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">accesskey</span><span class="p">,</span> <span class="p">{</span> <span class="na">asBytes</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span> 
<span class="kd">var</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nx">Crypto</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">bytesToBase64</span><span class="p">(</span><span class="nx">bytes</span><span class="p">);</span>
</pre></table></code></div></div><p>果然我一修改后,就上传成功了.<a href="#2附录">完整上传组件代码请查看附录</a></p><h2 id="2附录">2.附录</h2><p>自己封装了上传文件到阿里云OSS的 Ant design Upload组件的代码</p><div class="language-jsx highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nx">React</span><span class="p">,</span> <span class="p">{</span> <span class="nx">useState</span><span class="p">,</span> <span class="nx">useEffect</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Upload</span><span class="p">,</span> <span class="nx">Button</span><span class="p">,</span> <span class="nx">message</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">antd</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">UploadOutlined</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@ant-design/icons</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">_get</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">lodash/get</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">CryptoJS</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">crypto-js</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">encrypt</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/utils/crypto</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">OSS_CONFIG</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/config/OSSConfig</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">getUploadAccess</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/services/uploadFile</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">AliOSSUpload</span> <span class="o">=</span> <span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> 
    <span class="nx">ButtonName</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">点击上传文件</span><span class="dl">"</span><span class="p">,</span> 
    <span class="nx">maxFileListLength</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> 
    <span class="nx">onPreview</span><span class="p">,</span> 
    <span class="nx">listType</span><span class="p">,</span> 
    <span class="nx">uploadButton</span><span class="p">,</span> 
    <span class="nx">accept</span><span class="p">,</span> 
    <span class="na">uploadAccessInfo</span><span class="p">:</span> <span class="nx">propsUploadAccessInfo</span><span class="p">,</span>
  <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">OSSData</span><span class="p">,</span> <span class="nx">setOSSData</span><span class="p">]</span> <span class="o">=</span>  <span class="nx">useState</span><span class="p">({});</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">fileList</span><span class="p">,</span> <span class="nx">setFileList</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">([]);</span>

  <span class="kd">const</span> <span class="nx">onChange</span> <span class="o">=</span> <span class="p">(</span><span class="nx">fileInfo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fileInfo</span><span class="p">?.</span><span class="nx">file</span><span class="p">?.</span><span class="nx">status</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">error</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">message</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">上传失败,请重新上传</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="na">onChange</span><span class="p">:</span> <span class="nx">formCallback</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">props</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">formCallback</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">function</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">formCallback</span><span class="p">(</span><span class="nx">fileInfo</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">setFileList</span><span class="p">(</span><span class="nx">fileInfo</span><span class="p">.</span><span class="nx">fileList</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">onRemove</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">fileList</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">url</span> <span class="o">!==</span> <span class="nx">file</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">handleOSSData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">uploadAccessInfo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">expire</span> <span class="o">=</span> <span class="nx">_get</span><span class="p">(</span><span class="nx">uploadAccessInfo</span><span class="p">,</span> <span class="dl">'</span><span class="s1">sts_token.expiration</span><span class="dl">'</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>
      <span class="kd">const</span> <span class="nx">secret</span> <span class="o">=</span> <span class="nx">_get</span><span class="p">(</span><span class="nx">uploadAccessInfo</span><span class="p">,</span> <span class="dl">'</span><span class="s1">sts_token.access_key_secret</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">uuid</span> <span class="o">=</span> <span class="nx">_get</span><span class="p">(</span><span class="nx">uploadAccessInfo</span><span class="p">,</span> <span class="dl">'</span><span class="s1">script_uuid</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">accessId</span> <span class="o">=</span> <span class="nx">_get</span><span class="p">(</span><span class="nx">uploadAccessInfo</span><span class="p">,</span> <span class="dl">'</span><span class="s1">sts_token.access_key_id</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">);</span>
      <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">_get</span><span class="p">(</span><span class="nx">uploadAccessInfo</span><span class="p">,</span> <span class="dl">'</span><span class="s1">sts_token.security_token</span><span class="dl">'</span><span class="p">,</span> <span class="dl">''</span><span class="p">);</span>

      <span class="kd">const</span> <span class="nx">policyText</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">expiration</span><span class="p">:</span> <span class="nx">expire</span><span class="p">,</span>
        <span class="na">conditions</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span> <span class="na">bucket</span><span class="p">:</span> <span class="nx">OSS_CONFIG</span><span class="p">.</span><span class="nx">bucket</span> <span class="p">},</span>
        <span class="p">],</span>
      <span class="p">};</span>

      <span class="kd">const</span> <span class="nx">policyBase64</span> <span class="o">=</span> <span class="nx">encrypt</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">policyText</span><span class="p">));</span>
      <span class="c1">// must add { asBytes: true }, otherwise oss will return 403: SignatureDoesNotMatch</span>
      <span class="kd">const</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">HmacSHA1</span><span class="p">(</span><span class="nx">policyBase64</span><span class="p">,</span> <span class="nx">secret</span><span class="p">,</span> <span class="p">{</span> <span class="na">asBytes</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
      <span class="kd">const</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="nx">CryptoJS</span><span class="p">.</span><span class="nx">enc</span><span class="p">.</span><span class="nx">Base64</span><span class="p">);</span>

      <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">dir</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">OSS_CONFIG</span><span class="p">.</span><span class="nx">dir</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">uuid</span><span class="p">}</span><span class="s2">/`</span><span class="p">,</span>
        <span class="nx">expire</span><span class="p">,</span>
        <span class="na">host</span><span class="p">:</span> <span class="nx">OSS_CONFIG</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>
        <span class="nx">accessId</span><span class="p">,</span>
        <span class="na">policy</span><span class="p">:</span> <span class="nx">policyBase64</span><span class="p">,</span>
        <span class="nx">signature</span><span class="p">,</span>
        <span class="nx">token</span><span class="p">,</span>
        <span class="na">successActionStatus</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="p">};</span>
      <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">init</span> <span class="o">=</span> <span class="p">(</span><span class="nx">uploadAccessInfo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">initOSSData</span> <span class="o">=</span> <span class="nx">handleOSSData</span><span class="p">(</span><span class="nx">uploadAccessInfo</span><span class="p">);</span>
    <span class="nx">setOSSData</span><span class="p">(</span><span class="nx">initOSSData</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">fetchUploadAccess</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">getUploadAccess</span><span class="p">().</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">init</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="nx">message</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">获取上传权限失败</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
  
  <span class="kd">const</span> <span class="nx">beforeUpload</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">OSSData</span><span class="p">.</span><span class="nx">expire</span> <span class="o">&lt;</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">fetchUploadAccess</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">suffix</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">));</span>
    <span class="kd">const</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">+</span> <span class="nx">suffix</span><span class="p">;</span>
    <span class="nx">file</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">OSSData</span><span class="p">.</span><span class="nx">dir</span><span class="p">}${</span><span class="nx">filename</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    <span class="nx">file</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">OSSData</span><span class="p">.</span><span class="nx">host</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">OSSData</span><span class="p">.</span><span class="nx">dir</span><span class="p">}${</span><span class="nx">filename</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">file</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">const</span> <span class="nx">getExtraData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">key</span><span class="p">:</span> <span class="nx">file</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
      <span class="na">OSSAccessKeyId</span><span class="p">:</span> <span class="nx">OSSData</span><span class="p">.</span><span class="nx">accessId</span><span class="p">,</span>
      <span class="na">policy</span><span class="p">:</span> <span class="nx">OSSData</span><span class="p">.</span><span class="nx">policy</span><span class="p">,</span>
      <span class="na">Signature</span><span class="p">:</span> <span class="nx">OSSData</span><span class="p">.</span><span class="nx">signature</span><span class="p">,</span>
      <span class="dl">'</span><span class="s1">x-oss-security-token</span><span class="dl">'</span><span class="p">:</span> <span class="nx">OSSData</span><span class="p">.</span><span class="nx">token</span><span class="p">,</span>
      <span class="na">success_action_status</span><span class="p">:</span> <span class="nx">OSSData</span><span class="p">.</span><span class="nx">successActionStatus</span><span class="p">,</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">propsUploadAccessInfo</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fetchUploadAccess</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">init</span><span class="p">(</span><span class="nx">propsUploadAccessInfo</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="p">[</span><span class="nx">propsUploadAccessInfo</span><span class="p">]);</span>

  <span class="kd">const</span> <span class="nx">uploadProps</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">file</span><span class="dl">"</span><span class="p">,</span>
    <span class="nx">fileList</span><span class="p">,</span>
    <span class="na">action</span><span class="p">:</span> <span class="nx">OSSData</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>
    <span class="nx">listType</span><span class="p">,</span>
    <span class="nx">onPreview</span><span class="p">,</span>
    <span class="nx">accept</span><span class="p">,</span>
    <span class="nx">onChange</span><span class="p">,</span>
    <span class="nx">onRemove</span><span class="p">,</span>
    <span class="na">data</span><span class="p">:</span> <span class="nx">getExtraData</span><span class="p">,</span>
    <span class="nx">beforeUpload</span><span class="p">,</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;&gt;</span>
      <span class="p">&lt;</span><span class="nc">Upload</span> <span class="si">{</span><span class="p">...</span><span class="nx">uploadProps</span><span class="si">}</span> <span class="p">&gt;</span>
        <span class="si">{</span>  
          <span class="nx">listType</span> <span class="p">?</span> <span class="p">(</span><span class="nx">fileList</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">maxFileListLength</span> <span class="p">?</span> <span class="kc">null</span> <span class="p">:</span> <span class="nx">uploadButton</span><span class="p">)</span> <span class="p">:</span> <span class="p">(&lt;</span><span class="nc">Button</span> <span class="na">icon</span><span class="p">=</span><span class="si">{</span><span class="p">&lt;</span><span class="nc">UploadOutlined</span> <span class="p">/&gt;</span><span class="si">}</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">ButtonName</span><span class="si">}</span><span class="p">&lt;/</span><span class="nc">Button</span><span class="p">&gt;)</span>
        <span class="si">}</span>
      <span class="p">&lt;/</span><span class="nc">Upload</span><span class="p">&gt;</span>
    <span class="p">&lt;/&gt;</span>
  <span class="p">);</span>
<span class="p">};</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">AliOSSUpload</span><span class="p">;</span>

</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/issue/'>Issue</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ali-oss/" class="post-tag no-text-decoration" >Ali-OSS</a> <a href="/tags/react-js/" class="post-tag no-text-decoration" >React.js</a> <a href="/tags/ant-design/" class="post-tag no-text-decoration" >Ant Design</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=前端使用Ant design Upload组件上传文件到阿里云OSS的坑 - Ligengxin's Blog&url=/posts/work-problem-Ali-OSS/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=前端使用Ant design Upload组件上传文件到阿里云OSS的坑 - Ligengxin's Blog&u=/posts/work-problem-Ali-OSS/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=前端使用Ant design Upload组件上传文件到阿里云OSS的坑 - Ligengxin's Blog&url=/posts/work-problem-Ali-OSS/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/react-js/">React.js</a> <a class="post-tag" href="/tags/sql-server/">SQL Server</a> <a class="post-tag" href="/tags/transact-sql/">Transact-SQL</a> <a class="post-tag" href="/tags/ant-design/">Ant Design</a> <a class="post-tag" href="/tags/huawei-cloud/">HUAWEI Cloud</a> <a class="post-tag" href="/tags/javascript/">JavaScript</a> <a class="post-tag" href="/tags/summary/">Summary</a> <a class="post-tag" href="/tags/ali-oss/">Ali-OSS</a> <a class="post-tag" href="/tags/azure-function/">Azure Function</a> <a class="post-tag" href="/tags/azure/">Azure</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/antd-form-get-upload-fileLsit-info/"><div class="card-body"> <span class="timeago small" > Jan 19 <i class="unloaded">2021-01-19T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>使用Ant design Form组件获取Upload组件的fileList信息</h3><div class="text-muted small"><p>   简述下我的业务场景,一个Modal组件中使用了Form组件,而这个Form组件又包含了一些别的组件,然后在点击Modal的确认按钮把Form表单的数据全部发送给Api. 不看过程直接看代码的 1.问题出现   在完成一切后,我发现点击确认按钮后并不能获取到Form组件下面Upload组件的信息,当时就想应该这个组件Api是支持的,然后看了一遍Form组件和Upload组件的发现了一个...</p></div></div></a></div><div class="card"> <a href="/posts/go-deep-react-chapter-2/"><div class="card-body"> <span class="timeago small" > Nov 12, 2020 <i class="unloaded">2020-11-12T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>深入React技术栈第2章总结</h3><div class="text-muted small"><p>   深入React技术栈第2章总结 1.React 的事件机制   React有自己的事件机制，所以你在React使用事件函数比如在onClick的时候，你会发现他的写法是驼峰式命名,而原生的事件直接就是onclick.而且在常用的事件,比如onclick的回调函数中，获取的event并不是一个原生事件，打印出来是一个SyntheticEvent对象(proto: SyntheticEve...</p></div></div></a></div><div class="card"> <a href="/posts/how-does-react-work/"><div class="card-body"> <span class="timeago small" > Feb 19 <i class="unloaded">2021-02-19T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>React机制分析总结</h3><div class="text-muted small"><p> 1.Virtual DOM   简单说下我对于 Virtual DOM的理解.顾名思义就是虚拟DOM,其实就是在内存中表示的DOM树.那如何在内存中表示DOM树呢,很简单使用一个JSON对象,通过不断在children属性中加入一个个类似的JSON对象,这样就能在内存构建出一棵虚拟的DOM树. 1 2 3 4 5 6 7 8 { tagName: 'div', // 标签名 pro...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/my-2020-summary/" class="btn btn-outline-primary"><p>我的2020年终总结</p></a> <a href="/posts/antd-form-get-upload-fileLsit-info/" class="btn btn-outline-primary"><p>使用Ant design Form组件获取Upload组件的fileList信息</p></a></div><div id="gitalk-container"> <script> const gitalk = new Gitalk({ clientID: 'ef43f800a04cc65684b8', clientSecret: '60713915b72af48819c6e0389766198a7410ee48', repo: 'blog', owner: 'Ligengxin96', admin: ['Ligengxin96'], id : location.pathname, distractionFreeMode: false, proxy: 'https://netnr-proxy.cloudno.de/https://github.com/login/oauth/access_token' }); gitalk.render('gitalk-container') </script></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/Ligengxin1">Gengxin Li</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/react-js/">React.js</a> <a class="post-tag" href="/tags/sql-server/">SQL Server</a> <a class="post-tag" href="/tags/transact-sql/">Transact SQL</a> <a class="post-tag" href="/tags/ant-design/">Ant Design</a> <a class="post-tag" href="/tags/huawei-cloud/">HUAWEI Cloud</a> <a class="post-tag" href="/tags/javascript/">JavaScript</a> <a class="post-tag" href="/tags/summary/">Summary</a> <a class="post-tag" href="/tags/ali-oss/">Ali OSS</a> <a class="post-tag" href="/tags/azure-function/">Azure Function</a> <a class="post-tag" href="/tags/azure/">Azure</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
